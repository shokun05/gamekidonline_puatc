<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Kids HappyLand puatc✨🎈</title>
  <meta name="description" content="เว็บเล่นเกมสำหรับเด็กอนุบาล: ภาพใหญ่ กดง่าย สีสบายตา พร้อมบันทึกผลงานเป็น PDF/JPG" />
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #f7fbff;
      --card: #ffffff;
      --ink: #1b1f23;
      --soft-ink:#4b5563;
      --brand:#4f46e5;
      --brand-2:#22c55e;
      --accent:#fde68a;
      --selected:#4b5563;
      --correct:#22c55e;
      --wrong:#ef4444;
      --shadow: 0 10px 20px rgba(0,0,0,.06), 0 2px 6px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      line-height:1.45; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    header{
      position:sticky; top:0; z-index:20; backdrop-filter: blur(6px);
      background:rgba(247,251,255,.85); border-bottom:1px solid #e5e7eb;
    }
    .container{
      max-width: min(1920px, 98vw);
      margin: 0 auto;
      padding: clamp(10px, 2.2vw, 18px);
    }
    .topbar{display:flex; align-items:center; gap:12px; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg,var(--brand),#7c3aed); box-shadow:var(--shadow); object-fit:cover}
    .brand h1{font-size:20px; margin:0}
    .child-name{
      display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:8px 12px; box-shadow:var(--shadow);
    }
    .child-name input{border:0; outline:0; font-size:16px; width:180px}
    .btn{
      appearance:none; border:0; cursor:pointer; padding:12px 16px; border-radius:16px; font-weight:700; box-shadow:var(--shadow);
      background:var(--brand); color:white; font-size:16px; transition:transform .05s ease; text-decoration:none; display:inline-block;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#0ea5e9}
    .btn.ghost{background:var(--card); color:var(--ink); border:1px solid #e5e7eb}
    .btn.next-big{ padding:18px 26px; font-size:20px; border-radius:22px; }
    .btn.tts{ background:#22c55e; }
    .btn.tts.ghost{ background:var(--card); border:2px dashed #86efac; color:#065f46; }
    body{
      background: url("https://png.pngtree.com/thumb_back/fh260/background/20211217/pngtree-large-background-material-picture-download-desktop-wallpaper-image_922833.jpg") center/cover fixed no-repeat;
    }
    body::before{
      content:""; position:fixed; inset:0; background:rgba(255,255,255,.72); z-index:-1;
    }
    .games-grid{
    --gap: clamp(12px, 1.4vw, 18px);
    display: grid;
    gap: var(--gap);
    margin-inline: auto;
    }
    @media (max-width: 699px){
    .games-grid{ grid-template-columns: repeat(2, minmax(140px,1fr)); }
    }
    @media (min-width:700px) and (max-width: 1099px){
    .games-grid{ grid-template-columns: repeat(4, minmax(160px,1fr)); }
    }
    @media (min-width:1100px){
    .games-grid{ grid-template-columns: repeat(6, minmax(0,1fr)); }
    }
    @media (min-width:1100px){
    .games-grid.centered{
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      max-width: calc(6 * 220px + 5 * var(--gap));
      justify-content: center;
    }
    }
    .game-card{ display:block; background:var(--card); border-radius:22px; overflow:hidden; text-decoration:none; color:inherit; box-shadow:var(--shadow); border:1px solid #eef2f7; }
    .game-thumb{ aspect-ratio: 16/12; display:flex; align-items:center; justify-content:center; font-size:76px; }
    .game-card img{width:100%; height:100%; object-fit:contain; padding:12px}
    .game-meta{padding:12px 14px;}
    .game-title{font-size:18px; font-weight:800; margin:0 0 6px}
    .game-desc{margin:0; color:var(--soft-ink); font-size:14px}
    .screen{display:none}
    .screen.active{display:block}
    .game-wrap{background:var(--card); border-radius:26px; padding:16px; box-shadow:var(--shadow); border:1px solid #eef2f7}
    .crumbs{display:flex; align-items:center; gap:10px; margin-bottom:10px}
    .crumbs a{color:#2563eb; text-decoration:none; font-weight:700}
    .progress{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 18px; }
    .bar{flex:1; height:14px; background:#e5e7eb; border-radius:999px; overflow:hidden}
    .bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),#06b6d4);}
    .question{font-size:26px; font-weight:900; margin:6px 0 8px}
    .q-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:6px 0 14px; }
    .options{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .option{
      position:relative; border:4px solid transparent; border-radius:24px; background:#f9fafb; cursor:pointer; overflow:hidden; user-select:none; outline:none;
      box-shadow:var(--shadow);
    }
    .option:focus-visible{outline:4px solid #60a5fa}
    .option.selected{border-color:var(--selected)}
    .option img.opt-img{width:100%; height:100%; object-fit:contain; background:white; aspect-ratio:1/1}
    .option footer{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:white;}
    .option .name{font-size:18px; font-weight:800}
    .sound-btn{border:0; background:#10b981; color:white; font-weight:800; padding:10px 12px; border-radius:12px; cursor:pointer}
    .mark{
      position:absolute; inset:auto 8px 8px auto; width:56px; height:56px; border-radius:50%; display:none; align-items:center; justify-content:center;
      background:white; box-shadow:var(--shadow); border:4px solid var(--correct); color:var(--correct); font-size:30px; font-weight:900;
    }
    .option.correct .mark{ display:flex }
    .option.wrong .mark{ display:flex; border-color:var(--wrong); color:var(--wrong) }

    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    #screen-find .actions,
    #screen-color .actions,
    #screen-quiz .actions,
    #screen-life .actions{ justify-content: center; gap: 14px; }
    #submitBtn,#submitBtn-color,#submitBtn-quiz,#submitBtn-life{
      font-size:22px; padding:18px 28px; border-radius:26px; min-width:280px; width:clamp(260px,42vw,460px); height:64px; box-shadow:var(--shadow);
    }
    #submitBtn[disabled],#submitBtn-color[disabled],#submitBtn-quiz[disabled],#submitBtn-life[disabled]{ opacity:.55; cursor:not-allowed; }
    @media (max-width:520px){
      #submitBtn,#submitBtn-color,#submitBtn-quiz,#submitBtn-life{ width:100%; min-width:0; }
    }
    .result{ margin-top:18px; padding:16px; border-radius:22px; background:linear-gradient(180deg,#f0f9ff,#ccfbf1); border:1px solid #bae6fd; box-shadow:var(--shadow); }
    .certificate{
      width: 100%; max-width: 900px; margin: 0 auto; background:white; border-radius:30px; box-shadow:var(--shadow);
      padding:28px; border:6px solid var(--accent); text-align:center;
    }
    .certificate h3{font-size:28px; margin:0 0 12px}
    .certificate .name{font-size:34px; font-weight:900}
    .certificate .score{font-size:22px; margin-top:6px}
    .certificate .summary{font-size:20px; margin-top:10px; color:#065f46; background:#ecfeff; display:inline-block; padding:8px 14px; border-radius:12px; border:1px dashed #99f6e4}
    .cert-row{display:flex; justify-content:center; gap:18px; flex-wrap:wrap; margin-top:16px}
    .muted{color:var(--soft-ink)}
    .hidden{display:none !important}
    .color-box{width:100%; aspect-ratio:1/1;}
    .option.color .name{font-size:20px}
    .emoji-title::after{ content:"  🎉🌈🎯"; }
    .review-btn{ border-style:dashed; border-color:#fde68a; }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#0ea5e9; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);
      font-weight:700; z-index:50; display:none;
    }
    .toast.error{ background:#ef4444; }
    .toast.show{ display:block; }
    #submitBtn-color { display: none !important; }
    #screen-home .emoji-title,
    #screen-home .muted{ text-align:center; }
    .section-analytics{ margin-top:40px; padding:22px; border-radius:26px; background:var(--card); box-shadow:var(--shadow); border:1px solid #eef2f7; }
    .analytics-row{ display:grid; gap:18px; grid-template-columns: 1fr; }
    @media (min-width:980px){ .analytics-row{ grid-template-columns: minmax(420px, 52%) 1fr; } }
    .chart-box{ padding-left: clamp(6px, 2vw, 24px); }
    .tabbar{display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px}
    .tabbar .tab{ border:0; background:#e5efff; color:#1e3a8a; font-weight:800; padding:10px 14px; border-radius:14px; cursor:pointer; box-shadow:var(--shadow); }
    .tabbar .tab.active{ background:var(--brand); color:#fff }
    .reveal{ opacity:0; transform:translateY(24px); transition: all .7s ease; }
    .reveal.show{ opacity:1; transform:none; }
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <div class="brand">
        <img class="logo" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR3wohI4eredJb2xRKso_61n5c00o733XwKMA&s" alt="โลโก้">
        <h1>Game Kids HappyLand puatc</h1>
      </div>
      <div class="child-name" aria-label="ตั้งชื่อนักเรียน">
        <span>👶 ชื่อเด็ก:</span>
        <input id="childName" type="text" inputmode="text" placeholder="พิมพ์ชื่อที่นี่" aria-label="ชื่อเด็ก" />
        <button class="btn ghost" id="saveNameBtn" title="บันทึกชื่อ">บันทึก</button>
        <a class="btn ghost review-btn" id="reviewBtn" target="_blank" rel="noopener"
           href="https://docs.google.com/forms/d/e/1FAIpQLSdFyr9Pt_H8c3yCccugGBqAKn5-vDr5lzJe0z1TzASWLGbDUw/viewform?usp=dialog"
           title="ส่งความคิดเห็นเกี่ยวกับเกม">รีวิว ⭐</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="screen-home" class="screen active" aria-label="หน้าเลือกเกม">
      <h2 class="emoji-title" style="margin:10px 0 14px">เลือกเกมที่อยากเล่น</h2>
      <div class="games-grid" id="gamesGrid"></div>
      <p class="muted" style="margin-top:10px">เลือกเล่นเกมได้เต็มที่เลยครับ!!! 🎮💥</p>
    </section>
    <section id="pie-section" class="section-analytics reveal hidden" aria-label="สถิติแบบวงกลม">
      <h2 style="text-align:center;margin:0 0 12px">จำนวนเด็กที่เข้าเล่น</h2>
      <div class="analytics-row">
        <div class="chart-box">
          <canvas id="pieChart" height="320"></canvas>
          <p class="muted" id="pieCaption" style="text-align:center;margin-top:8px"></p>
        </div>
        <div>
          <div style="font-size:26px; font-weight:800; margin:6px 0 10px">จากผลสำรวจพบว่า</div>
          <div id="pieRightText" style="line-height:1.85; font-size:22px"></div>
        </div>
      </div>
    </section>
    <section id="bar-section" class="section-analytics reveal hidden" aria-label="สถิติแบบแท่ง">
      <div class="tabbar" id="gameTabs"></div>
      <div class="analytics-row">
        <div class="chart-box">
          <canvas id="barChart" height="330"></canvas>
          <p class="muted" style="text-align:center;margin-top:8px">แกนนอน = คะแนน (1–10) • แกนตั้ง = จำนวนคน</p>
        </div>
        <div id="barRightText" style="font-size:18px; line-height:1.75"></div>
      </div>
    </section>
    <section id="screen-find" class="screen" aria-label="เกมเลือกภาพที่ถูกต้อง">
      <nav class="crumbs">
        <a href="#" class="backHome">← กลับหน้าแรก</a>
        <span class="muted">/ เลือกภาพที่ถูกต้อง</span>
      </nav>
      <div class="game-wrap">
        <div class="progress">
          <div><strong>ข้อที่ <span id="qIndex">1</span></strong> / 10</div>
          <div class="bar" aria-label="ความคืบหน้า"><span id="qBar" style="width:0%"></span></div>
        </div>
        <div class="question" id="qText">…</div>
        <div class="q-actions"><button class="btn tts ghost" id="qSpeakBtn">🔊 ฟังคำถาม</button></div>
        <div class="options"></div>
        <div class="actions">
          <button class="btn" id="submitBtn" disabled>ส่งคำตอบ ✅</button>
          <button class="btn ghost next-big hidden" id="skipWaitBtn" role="status">👉 ถัดไปทันที</button>
        </div>
        <div id="feedback" class="muted" style="margin-top:6px" aria-live="polite"></div>
        <div id="finishBlock" class="result hidden">
          <div class="certificate" id="certificate-find">
            <h3>🎉 เก่งมากเลย! 🏅</h3>
            <div class="name" id="certName">ชื่อเด็ก</div>
            <div class="score" id="certScore">คะแนน: 0/10</div>
            <div class="summary" id="certSummary-find">...</div>
            <div class="muted" id="certDate">วันที่</div>
            <div class="cert-row" style="margin-top:16px">
              <div style="font-size:56px">🏆</div><div style="font-size:56px">🎓</div><div style="font-size:56px">🌈</div><div style="font-size:56px">🥳</div>
            </div>
          </div>
          <div class="cert-row">
            <button class="btn secondary" id="dlPdf-find">ดาวน์โหลดเป็น PDF 🧾</button>
            <button class="btn ghost" id="dlJpg-find">ดาวน์โหลดเป็น JPG 🖼️</button>
            <button class="btn" id="playAgain">เล่นอีกครั้ง 🔁</button>
            <button class="btn ghost backHome">กลับหน้าแรก 🏠</button>
          </div>
        </div>
      </div>
    </section>
    <section id="screen-color" class="screen" aria-label="เกมเลือกสีที่ถูกต้อง">
      <nav class="crumbs">
        <a href="#" class="backHome">← กลับหน้าแรก</a>
        <span class="muted">/ เลือกสีที่ถูกต้อง</span>
      </nav>
      <div class="game-wrap">
        <div class="progress">
          <div><strong>ข้อที่ <span id="qIndex-color">1</span></strong> / 10</div>
          <div class="bar" aria-label="ความคืบหน้า"><span id="qBar-color" style="width:0%"></span></div>
        </div>
        <div class="question" id="qText-color">…</div>
        <div class="q-actions"><button class="btn tts ghost" id="qSpeakBtn-color">🔊 ฟังคำถาม</button></div>
        <div class="options" id="options-color"></div>
        <div class="actions">
          <button class="btn" id="submitBtn-color" disabled>ส่งคำตอบ ✅</button>
          <button class="btn ghost next-big hidden" id="skipWaitBtn-color" role="status">👉 ถัดไปทันที</button>
        </div>
        <div id="feedback-color" class="muted" style="margin-top:6px" aria-live="polite"></div>
        <div id="finishBlock-color" class="result hidden">
          <div class="certificate" id="certificate-color">
            <h3>🎉 เก่งมากเลย! 🎨</h3>
            <div class="name" id="certName-color">ชื่อเด็ก</div>
            <div class="score" id="certScore-color">คะแนน: 0/10</div>
            <div class="summary" id="certSummary-color">...</div>
            <div class="muted" id="certDate-color">วันที่</div>
            <div class="cert-row" style="margin-top:16px">
              <div style="font-size:56px">🏆</div><div style="font-size:56px">🎨</div><div style="font-size:56px">🌈</div><div style="font-size:56px">✨</div>
            </div>
          </div>
          <div class="cert-row">
            <button class="btn secondary" id="dlPdf-color">ดาวน์โหลดเป็น PDF 🧾</button>
            <button class="btn ghost" id="dlJpg-color">ดาวน์โหลดเป็น JPG 🖼️</button>
            <button class="btn" id="playAgain-color">เล่นอีกครั้ง 🔁</button>
            <button class="btn ghost backHome">กลับหน้าแรก 🏠</button>
          </div>
        </div>
      </div>
    </section>
    <section id="screen-quiz" class="screen" aria-label="เกมเลือกคำตอบที่ถูกต้อง">
      <nav class="crumbs">
        <a href="#" class="backHome">← กลับหน้าแรก</a>
        <span class="muted">/ เลือกคำตอบที่ถูกต้อง</span>
      </nav>
      <div class="game-wrap">
        <div class="progress">
          <div><strong>ข้อที่ <span id="qIndex-quiz">1</span></strong> / 10</div>
          <div class="bar" aria-label="ความคืบหน้า"><span id="qBar-quiz" style="width:0%"></span></div>
        </div>
        <div class="question" id="qText-quiz">…</div>
        <div class="q-actions"><button class="btn tts ghost" id="qSpeakBtn-quiz">🔊 ฟังคำถาม</button></div>
        <div class="options" id="options-quiz"></div>
        <div class="actions">
          <button class="btn" id="submitBtn-quiz" disabled>ส่งคำตอบ ✅</button>
          <button class="btn ghost next-big hidden" id="skipWaitBtn-quiz" role="status">👉 ถัดไปทันที</button>
        </div>
        <div id="feedback-quiz" class="muted" style="margin-top:6px" aria-live="polite"></div>
        <div id="finishBlock-quiz" class="result hidden">
          <div class="certificate" id="certificate-quiz">
            <h3>🎉 เก่งมากเลย! ❓🌿</h3>
            <div class="name" id="certName-quiz">ชื่อเด็ก</div>
            <div class="score" id="certScore-quiz">คะแนน: 0/10</div>
            <div class="summary" id="certSummary-quiz">...</div>
            <div class="muted" id="certDate-quiz">วันที่</div>
            <div class="cert-row" style="margin-top:16px">
              <div style="font-size:56px">🏆</div><div style="font-size:56px">❓</div><div style="font-size:56px">🌿</div><div style="font-size:56px">🎯</div>
            </div>
          </div>
          <div class="cert-row">
            <button class="btn secondary" id="dlPdf-quiz">ดาวน์โหลดเป็น PDF 🧾</button>
            <button class="btn ghost" id="dlJpg-quiz">ดาวน์โหลดเป็น JPG 🖼️</button>
            <button class="btn" id="playAgain-quiz">เล่นอีกครั้ง 🔁</button>
            <button class="btn ghost backHome">กลับหน้าแรก 🏠</button>
          </div>
        </div>
      </div>
    </section>
    <section id="screen-life" class="screen" aria-label="เกมชีวิตประจำวัน">
      <nav class="crumbs">
        <a href="#" class="backHome">← กลับหน้าแรก</a>
        <span class="muted">/ ชีวิตประจำวัน</span>
      </nav>
      <div class="game-wrap">
        <div class="progress">
          <div><strong>ข้อที่ <span id="qIndex-life">1</span></strong> / 10</div>
          <div class="bar" aria-label="ความคืบหน้า"><span id="qBar-life" style="width:0%"></span></div>
        </div>
        <div class="question" id="qText-life">…</div>
        <div class="q-actions"><button class="btn tts ghost" id="qSpeakBtn-life">🔊 ฟังคำถาม</button></div>
        <div class="options" id="options-life"></div>
        <div class="actions">
          <button class="btn" id="submitBtn-life" disabled>ส่งคำตอบ ✅</button>
          <button class="btn ghost next-big hidden" id="skipWaitBtn-life" role="status">👉 ถัดไปทันที</button>
        </div>
        <div id="feedback-life" class="muted" style="margin-top:6px" aria-live="polite"></div>
        <div id="finishBlock-life" class="result hidden">
          <div class="certificate" id="certificate-life">
            <h3>🎉 เก่งมากเลย! 🚗🍎</h3>
            <div class="name" id="certName-life">ชื่อเด็ก</div>
            <div class="score" id="certScore-life">คะแนน: 0/10</div>
            <div class="summary" id="certSummary-life">...</div>
            <div class="muted" id="certDate-life">วันที่</div>
            <div class="cert-row" style="margin-top:16px">
              <div style="font-size:56px">🏆</div><div style="font-size:56px">🚗</div><div style="font-size:56px">🍎</div><div style="font-size:56px">🌟</div>
            </div>
          </div>
          <div class="cert-row">
            <button class="btn secondary" id="dlPdf-life">ดาวน์โหลดเป็น PDF 🧾</button>
            <button class="btn ghost" id="dlJpg-life">ดาวน์โหลดเป็น JPG 🖼️</button>
            <button class="btn" id="playAgain-life">เล่นอีกครั้ง 🔁</button>
            <button class="btn ghost backHome">กลับหน้าแรก 🏠</button>
          </div>
        </div>
      </div>
    </section>
  </main>
  <div id="toast" class="toast" role="status" aria-live="polite">กำลังบันทึก...</div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbycf-ljCvqv_FcDsQTK_Mo0rzUVHWN_xq0z4lEJ9WKn_RGXseDrt1avHm4BbQduvGYJ/exec';

    const toastEl = document.getElementById('toast');
    function toast(msg, isError=false, ms=1800){
      toastEl.textContent = msg;
      toastEl.classList.toggle('error', !!isError);
      toastEl.classList.add('show');
      setTimeout(()=> toastEl.classList.remove('show'), ms);
    }

    async function postWithTimeout(url, options={}, timeoutMs=8000){
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, { ...options, signal: ctrl.signal });
        clearTimeout(id);
        return res;
      }catch(err){
        clearTimeout(id);
        throw err;
      }
    }
    async function logResult(gameId, gameTitle, score){
      const payload = {
        name: (localStorage.getItem('childName')||'น้องเก่ง').trim(),
        gameId, gameTitle,
        score: Number(score)||0,
        submittedAtISO: new Date().toISOString()
      };
      try{
        toast('กำลังบันทึกผล...');
        const res = await postWithTimeout(APPS_SCRIPT_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload),
        }, 8000);

        let ok = false;
        try{
          const data = await res.json();
          ok = !!data?.ok;
        }catch(e){
          ok = res.ok;
        }
        if(ok){
          toast('บันทึกสำเร็จ ✅');
          return;
        }
        throw new Error('CORS or JSON parse failed');
      }catch(e1){
        console.warn('POST normal failed, fallback to no-cors:', e1);
        try{
          await postWithTimeout(APPS_SCRIPT_URL, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(payload),
            mode:'no-cors'
          }, 8000);
          toast('ส่งแล้ว (โหมด no-cors) ✅');
        }catch(e2){
          console.error('POST no-cors failed:', e2);
          toast('บันทึกไม่สำเร็จ', true);
        }
      }
    }
  </script>

  <script>
    const games = [
      { id: 'find',  title: 'เลือกภาพที่ถูกต้อง 🐾', desc: 'ลองเล่นดูสิครับสนุกแน่นอน 🎉', icon: '1.png' },
      { id: 'color', title: 'เลือกสีที่ถูกต้อง 🌈',  desc: 'ลองเล่นดูสิครับสนุกแน่นอน 🎨', icon: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f308.svg' },
      { id: 'quiz',  title: 'เลือกคำตอบที่ถูกต้อง ✍️', desc: 'ลองเล่นดูสิครับสนุกแน่นอน 🤔', icon: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/2753.svg' },
      { id: 'life',  title: 'ชีวิตประจำวัน 🚗🍎', desc: 'ลองเล่นดูสิครับสนุกแน่นอน 🧩', icon: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3c3.svg' }
    ];

    const GAME_TITLES = {
      find: 'เลือกภาพที่ถูกต้อง',
      color: 'เลือกสีที่ถูกต้อง',
      quiz: 'เลือกคำตอบที่ถูกต้อง',
      life: 'ชีวิตประจำวัน'
    };

    const gamesGrid = document.getElementById('gamesGrid');
    games.forEach(g => {
      const a = document.createElement('a');
      a.href = '#'; a.className = 'game-card'; a.dataset.game = g.id;
      a.innerHTML = `
        <div class="game-thumb"><img alt="${g.title}" src="${g.icon}"></div>
        <div class="game-meta">
          <div class="game-title">${g.title}</div>
          <p class="game-desc">${g.desc}</p>
        </div>
      `;
      a.addEventListener('click', (e)=>{ e.preventDefault(); openGame(g.id); });
      gamesGrid.appendChild(a);
    });
    function syncGamesGridCentering(){
      const count = gamesGrid.children.length;
      gamesGrid.classList.toggle('centered', count < 6);
    }
    syncGamesGridCentering();
    const backHomeLinks = document.querySelectorAll('.backHome');
    backHomeLinks.forEach(el => el.addEventListener('click', (e)=>{ e.preventDefault(); showScreen('home'); }));
    const analyticsEls = [
    document.getElementById('pie-section'),
    document.getElementById('bar-section')
    ];
    function setAnalyticsVisible(visible){
    analyticsEls.forEach(el => el.classList.toggle('hidden', !visible));
    }
    function showScreen(which){
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-'+which).classList.add('active');
    setAnalyticsVisible(which === 'home');
  window.scrollTo({top:0,behavior:'smooth'});
}
setAnalyticsVisible(true);
    function openGame(id){
      if(id==='find')  startFindGame();
      if(id==='color') startColorGame();
      if(id==='quiz')  startQuizGame();
      if(id==='life')  startLifeGame();
    }
    function speakThai(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        const voices = speechSynthesis.getVoices();
        const siri = voices.find(v => /siri/i.test(v.name) && /th|Thai/i.test(v.lang));
        const th   = voices.find(v => /th|Thai/i.test(v.lang));
        u.voice = siri || th || voices[0];
        u.rate = 0.95; u.pitch = 1.0; u.volume = 1.0;
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch(err){ console.warn('speech failed', err); }
    }
    window.speechSynthesis && (speechSynthesis.onvoiceschanged = ()=>{});
    const audioPlayer = new Audio();
    audioPlayer.preload = 'auto';
    const ANIMALS = [
      { key:'elephant', name:'ช้าง', imageUrl:'https://pngfile.net/files/preview/1280x957/21565851986bbscuwaiidwdnhq8y2ealfi4js8ykwz8zw5jt3o7fdaekwggribblx66oc0joidxdw3gtjo3l69apebps8ulquytobfk6qoslhwx.png' },
      { key:'lion', name:'สิงโต', imageUrl:'https://img.freepik.com/free-photo/3d-animated-cartoon-lion_23-2150800715.jpg' },
      { key:'tiger', name:'เสือ', imageUrl:'https://static.vecteezy.com/system/resources/thumbnails/049/159/624/small_2x/royal-bangle-tiger-3d-cartoon-image-png.png' },
      { key:'horse', name:'ม้า', imageUrl:'https://png.pngtree.com/png-vector/20241024/ourmid/pngtree-horse-cartoon-png-image_14162403.png' },
      { key:'cow', name:'วัว', imageUrl:'https://i.pinimg.com/736x/e9/4e/53/e94e536c7dbeebdd212ac77ffb8ee945.jpg' },
      { key:'pig', name:'หมู', imageUrl:'https://img.freepik.com/premium-vector/cute-cartoon-pig-illustration_53876-241258.jpg' },
      { key:'dog', name:'สุนัข', imageUrl:'https://png.pngtree.com/png-vector/20231017/ourmid/pngtree-cute-cartoon-happy-dog-png-file-png-image_10201723.png' },
      { key:'cat', name:'แมว', imageUrl:'https://img.freepik.com/premium-vector/cute-cartoon-white-cat-isolated-white-background_1057-111316.jpg' },
      { key:'rabbit', name:'กระต่าย', imageUrl:'https://img.freepik.com/premium-photo/cute-cartoon-bunny-rabbit-sitting_494260-1314.jpg' },
      { key:'bear', name:'หมี', imageUrl:'https://png.pngtree.com/png-vector/20240621/ourmid/pngtree-sweet-grizzly-bear-cartoon-art-for-kids-png-image_12812227.png' },
      { key:'panda', name:'แพนด้า', imageUrl:'https://i.pinimg.com/564x/c7/30/54/c73054170fb13bbfc0db839ea8526bdf.jpg' },
      { key:'koala', name:'โคอาลา', imageUrl:'https://img.freepik.com/free-vector/cute-koala-cartoon-character_1308-132636.jpg' },
      { key:'fox', name:'สุนัขจิ้งจอก', imageUrl:'https://static.vecteezy.com/system/resources/thumbnails/048/332/545/small_2x/smiling-cartoon-fox-on-transparent-background-free-png.png' },
      { key:'monkey', name:'ลิง', imageUrl:'https://gallery.yopriceville.com/downloadfullsize/send/9309' },
      { key:'frog', name:'กบ', imageUrl:'https://i.pinimg.com/736x/a0/5c/88/a05c883721a2397785439e4799ba2962.jpg' },
      { key:'chicken', name:'ไก่', imageUrl:'https://static.vecteezy.com/system/resources/thumbnails/044/315/179/small_2x/cartoon-of-a-chicken-hen-free-png.png' },
      { key:'penguin', name:'เพนกวิน', imageUrl:'https://png.pngtree.com/png-vector/20240429/ourmid/pngtree-happy-penguin-cute-cartoon-art-png-image_12341225.png' },
      { key:'bird', name:'นก', imageUrl:'https://t3.ftcdn.net/jpg/01/19/50/64/360_F_119506410_FPYY0xlKYmqV5B3nLr1o0XaVbi3weO5k.jpg' },
      { key:'duck', name:'เป็ด', imageUrl:'https://img.freepik.com/premium-vector/print_1126632-1731.jpg' },
      { key:'eagle', name:'นกอินทรี', imageUrl:'https://gallery.yopriceville.com/var/albums/Free-Clipart-Pictures/Birds-PNG/Eagle_PNG_PNG_Clip_Art_Image.png?m=1629783192' },
      { key:'owl', name:'นกฮูก', imageUrl:'https://img.freepik.com/free-vector/cute-owl-perched-branch_1308-165797.jpg?semt=ais_hybrid&w=740&q=80' },
      { key:'boar', name:'หมูป่า', imageUrl:'https://img.freepik.com/free-vector/friendly-cartoon-warthog-illustration_1308-165814.jpg' },
      { key:'rhinoceros', name:'แรด', imageUrl:'https://i.pinimg.com/736x/72/8d/a2/728da2bc476d67bf7f9ddace84f690ea.jpg' },
      { key:'hippo', name:'ฮิปโปโปเตมัส', imageUrl:'https://img.freepik.com/free-vector/cheerful-cartoon-hippopotamus-illustration_1308-165828.jpg?semt=ais_hybrid&w=740&q=80' },
      { key:'crocodile', name:'จระเข้', imageUrl:'https://i.pinimg.com/736x/08/41/90/0841904825819f295262cea0d191db4c.jpg' },
      { key:'turtle', name:'เต่า', imageUrl:'https://t3.ftcdn.net/jpg/02/12/04/16/360_F_212041631_IlUpamHEbdvRMmzfuXav1XORBnaIXuEf.jpg' },
      { key:'lizard', name:'กิ้งก่า', imageUrl:'https://img.freepik.com/premium-vector/cute-chameleon-cartoon-white-background_188253-10024.jpg' },
      { key:'snake', name:'งู', imageUrl:'https://png.pngtree.com/png-vector/20240216/ourmid/pngtree-snake-illustration-png-image_11743292.png' },
      { key:'whale', name:'วาฬ', imageUrl:'https://t4.ftcdn.net/jpg/11/41/83/01/360_F_1141830138_wkG4bn4KRbI0tGFKLqLS1EGkmoR2Cvb5.jpg' },
      { key:'dolphin', name:'ปลาโลมา', imageUrl:'https://parspng.com/wp-content/uploads/2024/03/dolphinpng.parspng.com-4.png' },
      { key:'fish', name:'ปลา', imageUrl:'https://png.pngtree.com/png-vector/20230814/ourmid/pngtree-blue-cartoon-fish-sticker-on-a-white-background-vector-png-image_6892122.png' },
      { key:'shark', name:'ฉลาม', imageUrl:'https://img.freepik.com/premium-vector/cute-cartoon-shark-vector-illustration-isolated-white-background_1151-31435.jpg' },
      { key:'octopus', name:'ปลาหมึก', imageUrl:'https://static.vecteezy.com/system/resources/previews/038/265/329/non_2x/ai-generated-octopus-in-cartoon-style-on-transparent-background-free-png.png' },
      { key:'butterfly', name:'ผีเสื้อ', imageUrl:'https://static.vecteezy.com/ti/gratis-vektor/p1/11181097-sot-rod-leende-fjaril-isolerat-pa-vit-bakgrund-rolig-insekt-for-barn-platt-tecknad-serie-vektor-illustration-vector.jpg' },
      { key:'ladybeetle', name:'เต่าทอง', imageUrl:'https://static.vecteezy.com/system/resources/thumbnails/039/657/514/small_2x/ai-generated-cartoon-of-ladybug-transparent-background-free-png.png' },
      { key:'ant', name:'มด', imageUrl:'https://parspng.com/wp-content/uploads/2024/05/antpng.parspng.com-2.png' },
      { key:'bee', name:'ผึ้ง', imageUrl:'https://img.pikbest.com/png-images/20240804/honey-bee-cartoon-character-illustration-png_10698271.png!sw800' },
      { key:'deer', name:'กวาง', imageUrl:'https://png.pngtree.com/png-vector/20220807/ourmid/pngtree-cartoon-deer-in-the-grass-png-image_5769272.png'}
    ];
    const SOUND_URLS = {
      elephant:'sound/elephant.mp3', lion:'sound/lion.mp3', tiger:'sound/tiger.mp3',
      horse:'sound/horse.mp3', cow:'sound/cow.mp3', pig:'sound/pig.mp3',
      dog:'sound/dog.mp3', cat:'sound/cat.mp3', rabbit:'sound/rabbit.mp3',
      bear:'sound/bear.mp3', panda:'sound/koala.mp3', koala:'sound/koala.mp3',
      fox:'sound/fox.mp3', monkey:'sound/monkey.mp3', frog:'sound/frog.mp3',
      chicken:'sound/chicken.mp3', penguin:'sound/penguin.mp3', bird:'sound/bird.mp3',
      duck:'sound/duck.mp3', eagle:'sound/eagle.mp3', owl:'sound/owl.mp3',
      boar:'sound/boar.mp3', rhinoceros:'sound/rhinoceros.mp3', hippo:'sound/hippo.mp3',
      crocodile:'sound/crocodile.mp3', turtle:'sound/turtle.mp3', lizard:'sound/lizard.mp3',
      snake:'sound/snake.mp3', whale:'sound/whale.mp3', dolphin:'sound/dolphin.mp3',
      fish:'sound/fish.mp3', shark:'sound/shark.mp3', octopus:'sound/octopus.mp3',
      butterfly:'sound/butterfly.mp3', ladybeetle:'sound/ladybeetle.mp3', ant:'sound/ant.mp3', bee:'sound/bee.mp3'
    };
    function playAnimalSound(keyOrName){
      let key = keyOrName;
      if(!SOUND_URLS[keyOrName]){
        const found = ANIMALS.find(a=>a.name===keyOrName || a.key===keyOrName);
        key = found ? found.key : keyOrName;
      }
      const url = SOUND_URLS[key];
      if(url){
        try{
          audioPlayer.pause(); audioPlayer.currentTime = 0;
          audioPlayer.src = url;
          audioPlayer.onerror = ()=> speakThai(ANIMALS.find(a=>a.key===key)?.name || key);
          audioPlayer.play().catch(()=> speakThai(ANIMALS.find(a=>a.key===key)?.name || key));
        }catch(e){ speakThai(ANIMALS.find(a=>a.key===key)?.name || key); }
      }else{
        speakThai(ANIMALS.find(a=>a.key===key)?.name || key);
      }
    }

    const EMOJIS = ["🌟","🎉","🎈","🥳","🌈","✨","💫","🎯","🧠","🧩","🐾","🍀","🚀"];
    function addEmojis(text, count=2){
      const pick = []; for(let i=0;i<count;i++){ pick.push(EMOJIS[Math.floor(Math.random()*EMOJIS.length)]); }
      return `${text} ${pick.join(" ")}`;
    }
    function setCertSummary(gameKey){
      const title = GAME_TITLES[gameKey] || '';
      const el = document.getElementById(`certSummary-${gameKey}`);
      if(el){ el.textContent = title; }
    }
    const scrFind = document.getElementById('screen-find');
    const qText = document.getElementById('qText');
    const qIndexEl = document.getElementById('qIndex');
    const qBar = document.getElementById('qBar');
    const optionsEl = scrFind.querySelector('.options');
    const submitBtn = document.getElementById('submitBtn');
    const skipWaitBtn = document.getElementById('skipWaitBtn');
    const feedback = document.getElementById('feedback');
    const finishBlock = document.getElementById('finishBlock');
    const certName = document.getElementById('certName');
    const certScore = document.getElementById('certScore');
    const certDate = document.getElementById('certDate');
    const playAgain = document.getElementById('playAgain');
    const qSpeakBtn = document.getElementById('qSpeakBtn');
    let bank = []; let quiz = []; let qIdx = 0; let score = 0; let selected = null; let nextTimer = null;
    let currentQuestionText = "…";
    function buildBank(){
      bank = ANIMALS.slice(0, 30).map((ani, i) => {
        let other;
        do{ other = ANIMALS[Math.floor(Math.random()*ANIMALS.length)]; } while(other.key === ani.key);
        const correctIndex = Math.random() < 0.5 ? 0 : 1;
        const left = correctIndex===0 ? ani : other;
        const right = correctIndex===1 ? ani : other;
        return {
          id: i+1,
          ask: `${ani.name}คือตัวไหน?`,
          correctIndex,
          options: [
            { name: left.name,  key: left.key,  img: left.imageUrl,  alt: `รูป${left.name}` },
            { name: right.name, key: right.key, img: right.imageUrl, alt: `รูป${right.name}` }
          ],
          correctName: ani.name
        };
      });
    }
    function pick10(){
      const arr = bank.slice();
      for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i], arr[j]] = [arr[j], arr[i]]; }
      quiz = arr.slice(0,10);
    }
    function startFindGame(){
      showScreen('find');
      buildBank(); pick10();
      qIdx = 0; score = 0; selected = null;
      feedback.textContent = '';
      qBar.style.width = '0%';
      finishBlock.classList.add('hidden');
      clearTimeout(nextTimer);
      renderQuestion();
    }
    function renderQuestion(){
      const q = quiz[qIdx];
      currentQuestionText = q.ask;
      qText.textContent = addEmojis(q.ask, 2);
      qIndexEl.textContent = (qIdx+1);
      qBar.style.width = `${(qIdx)/10*100}%`;
      optionsEl.innerHTML = '';
      selected = null; submitBtn.disabled = true; skipWaitBtn.classList.add('hidden');
      feedback.textContent='';
      q.options.forEach((opt, idx) => {
        const card = document.createElement('button');
        card.className = 'option'; card.type = 'button'; card.setAttribute('aria-pressed','false');
        card.innerHTML = `
          <img class="opt-img" data-key="${opt.key}" src="${opt.img}" alt="${opt.alt}">
          <footer>
            <span class="name">${opt.name}</span>
            <button class="sound-btn" type="button" aria-label="ฟังเสียงของ ${opt.name}">🔊 ฟังเสียง</button>
          </footer>
          <div class="mark">✔</div>
        `;
        card.addEventListener('click', (e)=>{
          if(e.target && e.target.classList.contains('sound-btn')) return;
          [...optionsEl.children].forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected');
          selected = idx; submitBtn.disabled = false; feedback.textContent='';
        });
        const imgEl = card.querySelector('.opt-img');
        imgEl.addEventListener('click', (e)=>{
          e.stopPropagation();
          [...optionsEl.children].forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected');
          selected = idx; submitBtn.disabled = false; feedback.textContent='';
          playAnimalSound(opt.key);
        });
        card.querySelector('.sound-btn').addEventListener('click', (e)=>{
          e.stopPropagation();
          playAnimalSound(opt.key);
        });
        optionsEl.appendChild(card);
      });
    }
    function revealAnswer(){
      const q = quiz[qIdx];
      const cards = [...optionsEl.children];
      cards.forEach((card, idx)=>{
        const mark = card.querySelector('.mark');
        if(idx===q.correctIndex){ card.classList.add('correct'); mark.title = 'ถูกต้อง'; }
        else if (selected===idx){ card.classList.add('wrong'); mark.textContent = '✖'; mark.title = 'ผิด'; }
      });
    }
    function submit(){
      if(selected===null) return;
      const q = quiz[qIdx];
      const correct = selected === q.correctIndex;
      if(correct) score++;
      revealAnswer();
      feedback.innerHTML = correct ? '✅ เก่งมาก! คำตอบถูกต้อง 🥳' : `❌ ยังไม่ถูกนะ ตัวที่ถูกคือ “${q.correctName}” 💡`;
      submitBtn.disabled = true;
      skipWaitBtn.classList.remove('hidden');
      clearTimeout(nextTimer);
      nextTimer = setTimeout(nextQuestion, 5000);
    }
    function nextQuestion(){
      clearTimeout(nextTimer);
      skipWaitBtn.classList.add('hidden');
      feedback.textContent = '';
      qIdx++;
      if(qIdx < 10){ renderQuestion(); } else { finish(); }
    }
    function finish(){
      qBar.style.width = '100%';
      const name = (localStorage.getItem('childName')||'น้องเก่ง');
      certName.textContent = name;
      certScore.textContent = `คะแนน: ${score}/10`;
      certDate.textContent = new Date().toLocaleString('th-TH', { dateStyle:'long', timeStyle:'short' });
      setCertSummary('find');
      finishBlock.classList.remove('hidden');
      document.getElementById('dlPdf-find').focus();
      logResult('find','เลือกภาพที่ถูกต้อง',score);
    }
    submitBtn.addEventListener('click', submit);
    skipWaitBtn.addEventListener('click', nextQuestion);
    playAgain.addEventListener('click', startFindGame);
    qSpeakBtn.addEventListener('click', ()=> speakThai(currentQuestionText));
    async function captureCertificate(elId){
      const target = document.getElementById(elId);
      const canvas = await html2canvas(target, { scale: 2, backgroundColor:'#ffffff' });
      const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
      return { canvas, dataUrl };
    }
    document.getElementById('dlJpg-find').addEventListener('click', async ()=>{
      const { dataUrl } = await captureCertificate('certificate-find');
      const a = document.createElement('a'); const name = (localStorage.getItem('childName')||'เด็กดี');
      a.href = dataUrl; a.download = `ผลงาน_${name}.jpg`; document.body.appendChild(a); a.click(); a.remove();
    });
    document.getElementById('dlPdf-find').addEventListener('click', async ()=>{
      const { jsPDF } = window.jspdf;
      const { canvas } = await captureCertificate('certificate-find');
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pdf = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
      const pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pageW/canvas.width, pageH/canvas.height);
      const w = canvas.width*ratio, h = canvas.height*ratio, x=(pageW-w)/2, y=(pageH-h)/2;
      pdf.addImage(imgData, 'JPEG', x, y, w, h);
      const name = (localStorage.getItem('childName')||'เด็กดี');
      pdf.save(`ผลงาน_${name}.pdf`);
    });

    const COLORS = [
      {name:'สีแดง',hex:'#ef4444'},{name:'สีเขียว',hex:'#22c55e'},{name:'สีน้ำเงิน',hex:'#3b82f6'},{name:'สีเหลือง',hex:'#eab308'},
      {name:'สีม่วง',hex:'#a855f7'},{name:'สีส้ม',hex:'#f97316'},{name:'สีชมพู',hex:'#ec4899'},{name:'สีฟ้า',hex:'#38bdf8'}
    ];
    const qSpeakBtnColor = document.getElementById('qSpeakBtn-color');
    let currentQuestionTextColor = "…";
    function startColorGame(){
      showScreen('color');
      const state = { idx:0, score:0, selected:null, quiz:[] , timer:null, locked:false };
      for(let i=0;i<10;i++){
        const ans=COLORS[Math.floor(Math.random()*COLORS.length)];
        let wrong; do{wrong=COLORS[Math.floor(Math.random()*COLORS.length)]}while(wrong===ans);
        const correctIndex=Math.random()<0.5?0:1;
        const opts=correctIndex? [wrong,ans]:[ans,wrong];
        state.quiz.push({ ask:`${ans.name}คือสีไหน?`, correctIndex, options:opts, correctName:ans.name });
      }
      renderColor(state);
    }
    function renderColor(st){
      const q = st.quiz[st.idx];
      st.locked = false;
      currentQuestionTextColor = q.ask;
      document.getElementById('qText-color').textContent = addEmojis(q.ask,2);
      document.getElementById('qIndex-color').textContent = st.idx+1;
      document.getElementById('qBar-color').style.width = `${(st.idx)/10*100}%`;
      const box = document.getElementById('options-color');
      box.innerHTML='';
      const skip = document.getElementById('skipWaitBtn-color');
      const fb = document.getElementById('feedback-color');
      skip.classList.add('hidden');
      fb.textContent='';
      q.options.forEach((opt, idx)=>{
        const card=document.createElement('button');
        card.className='option color'; card.type='button';
        card.innerHTML=`
          <div class="color-box" style="background:${opt.hex}"></div>
          <footer><span class="name">${opt.name}</span></footer>
          <div class="mark">✔</div>
        `;
        card.addEventListener('click', ()=>{
          if(st.locked) return;
          st.locked = true;
          const correct = idx===q.correctIndex;
          if(correct) st.score++;
          [...box.children].forEach((c,i)=>{
            const mark=c.querySelector('.mark');
            if(i===q.correctIndex){ c.classList.add('correct'); mark.title='ถูกต้อง'; }
            else if(i===idx){ c.classList.add('wrong'); mark.textContent='✖'; mark.title='ผิด'; }
          });
          fb.textContent = correct ? '✅ เก่งมาก! คำตอบถูกต้อง 🥳' : `❌ ยังไม่ถูกนะ คำตอบคือ “${q.correctName}” 💡`;
          skip.classList.remove('hidden');
          clearTimeout(st.timer);
          st.timer = setTimeout(()=>nextColor(st), 5000);
        });
        box.appendChild(card);
      });
      skip.onclick=()=>{ clearTimeout(st.timer); nextColor(st); };
      qSpeakBtnColor.onclick = ()=> speakThai(currentQuestionTextColor);
      document.getElementById('playAgain-color').onclick=()=> startColorGame();
    }
    function nextColor(st){
      st.idx++;
      if(st.idx<10) renderColor(st);
      else finishColor(st);
    }
    function finishColor(st){
      document.getElementById('qBar-color').style.width='100%';
      const name = (localStorage.getItem('childName')||'น้องเก่ง');
      document.getElementById('certName-color').textContent=name;
      document.getElementById('certScore-color').textContent=`คะแนน: ${st.score}/10`;
      document.getElementById('certDate-color').textContent=new Date().toLocaleString('th-TH',{dateStyle:'long', timeStyle:'short'});
      setCertSummary('color');
      document.getElementById('finishBlock-color').classList.remove('hidden');
      document.getElementById('dlPdf-color').focus();
      logResult('color','เลือกสีที่ถูกต้อง',st.score||0);
    }
    document.getElementById('dlJpg-color').addEventListener('click', async ()=>{
      const { dataUrl } = await captureCertificate('certificate-color');
      const a = document.createElement('a'); const name = (localStorage.getItem('childName')||'เด็กดี');
      a.href = dataUrl; a.download = `ผลงาน_${name}.jpg`; document.body.appendChild(a); a.click(); a.remove();
    });
    document.getElementById('dlPdf-color').addEventListener('click', async ()=>{
      const { jsPDF } = window.jspdf;
      const { canvas } = await captureCertificate('certificate-color');
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pdf = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
      const pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pageW/canvas.width, pageH/canvas.height);
      const w = canvas.width*ratio, h = canvas.height*ratio, x=(pageW-w)/2, y=(pageH-h)/2;
      pdf.addImage(imgData, 'JPEG', x, y, w, h);
      const name = (localStorage.getItem('childName')||'เด็กดี');
      pdf.save(`ผลงาน_${name}.pdf`);
    });

    const SETS = {
      water:      ['ปลา','ปลาโลมา','วาฬ','ฉลาม','ปลาหมึก','เต่า','จระเข้','เพนกวิน'],
      plantEater: ['ช้าง','วัว','ม้า','กระต่าย','แพนด้า','โคอาลา','กวาง','ลิง'],
      meatEater:  ['สิงโต','เสือ','งู','จระเข้','หมี','แรด','ฉลาม','นกอินทรี','นกฮูก','สุนัขจิ้งจอก'],
      air:        ['นก','นกฮูก','นกอินทรี','ผีเสื้อ','ผึ้ง'],
      land:       ['สุนัข','แมว','ลิง','กิ้งก่า','หมูป่า','แพนด้า','โคอาลา','สุนัขจิ้งจอก','แรด','หมี'],
      scary:      ['สิงโต','เสือ','งู','จระเข้','หมี','แรด','ฉลาม','ผึ้ง'],
      domestic:   ['แมว','สุนัข'],
      forest:     ['หมี','เสือ','ลิง','ช้าง','กวาง','หมูป่า','สุนัขจิ้งจอก','นกฮูก','แพนด้า','โคอาลา']
    };
    const nameToAnimal = Object.fromEntries(ANIMALS.map(a=>[a.name,a]));
    const randItem = arr => arr[Math.floor(Math.random()*arr.length)];
    function buildQuizBank(){
      const items = [];
      SETS.water.forEach(n=>{
        const wrongSource = Math.random()<0.5 ? SETS.land : SETS.air;
        let wrong; do{ wrong=randItem(wrongSource); }while(SETS.water.includes(wrong));
        items.push({ ask:'อะไรเอ่ยอยู่ในน้ำ', correct:n, wrong });
      });
      SETS.plantEater.forEach(n=>{
        let wrong; do{ wrong=randItem(SETS.meatEater); }while(wrong===n);
        items.push({ ask:'อะไรเอ่ยกินพืช', correct:n, wrong });
      });
      SETS.meatEater.forEach(n=>{
        let wrong; do{ wrong=randItem(SETS.plantEater); }while(wrong===n);
        items.push({ ask:'อะไรเอ่ยกินเนื้อ', correct:n, wrong });
      });
      SETS.air.forEach(n=>{
        const wrongSource = Math.random()<0.5 ? SETS.land : SETS.water;
        let wrong; do{ wrong=randItem(wrongSource); }while(SETS.air.includes(wrong));
        items.push({ ask:'อะไรเอ่ยอยู่บนท้องฟ้า', correct:n, wrong });
      });
      SETS.scary.forEach(n=>{
        const all = Array.from(new Set(Object.values(SETS).flat()));
        const nonScary = all.filter(x=>!SETS.scary.includes(x));
        let wrong = randItem(nonScary);
        items.push({ ask:'อะไรเอ่ยเป็นสัตว์น่ากลัว', correct:n, wrong });
      });
      SETS.domestic.forEach(n=>{
        let wrong; do{ wrong=randItem(SETS.forest); }while(SETS.domestic.includes(wrong));
        items.push({ ask:'อะไรเอ่ยเลี้ยงอยู่ในบ้านได้', correct:n, wrong });
      });
      SETS.forest.forEach(n=>{
        const candidates = Array.from(new Set([...SETS.water, ...SETS.air, ...SETS.domestic]));
        let wrong; do{ wrong=randItem(candidates); }while(SETS.forest.includes(wrong));
        items.push({ ask:'อะไรเอ่ยอยู่ในป่า', correct:n, wrong });
      });
      const out = items.map(it=>{
        const correctIndex = Math.random()<0.5?0:1;
        const leftName = correctIndex===0 ? it.correct : it.wrong;
        const rightName= correctIndex===1 ? it.correct : it.wrong;
        const leftObj  = nameToAnimal[leftName]  ? {
          name:leftName, key:nameToAnimal[leftName].key,
          img:nameToAnimal[leftName].imageUrl, alt:`รูป${leftName}`
        } : { name:leftName, textOnly:true };
        const rightObj = nameToAnimal[rightName] ? {
          name:rightName, key:nameToAnimal[rightName].key,
          img:nameToAnimal[rightName].imageUrl, alt:`รูป${rightName}`
        } : { name:rightName, textOnly:true };
        return { ask: it.ask, correctIndex, options:[leftObj,rightObj], correctName: it.correct };
      });
      return out.sort(()=>Math.random()-0.5).slice(0,10);
    }
    const qSpeakBtnQuiz = document.getElementById('qSpeakBtn-quiz');
    let currentQuestionTextQuiz = "…";

    function startQuizGame(){
      showScreen('quiz');
      document.getElementById('finishBlock-quiz').classList.add('hidden');
      document.getElementById('feedback-quiz').textContent = '';
      document.getElementById('qBar-quiz').style.width = '0%';
      const state = { idx:0, score:0, selected:null, quiz:buildQuizBank(), timer:null };
      renderQuiz(state);
    }
    function renderQuiz(st){
      const q = st.quiz[st.idx];
      const qTextEl = document.getElementById('qText-quiz');
      const qIndex = document.getElementById('qIndex-quiz');
      const qBar = document.getElementById('qBar-quiz');
      const options = document.getElementById('options-quiz');
      const submit = document.getElementById('submitBtn-quiz');
      const skip = document.getElementById('skipWaitBtn-quiz');
      const fb = document.getElementById('feedback-quiz');
      currentQuestionTextQuiz = q.ask;
      qTextEl.textContent = addEmojis(q.ask,2);
      qIndex.textContent = st.idx+1;
      qBar.style.width = `${(st.idx)/10*100}%`;
      options.innerHTML=''; st.selected=null; submit.disabled=true; skip.classList.add('hidden'); fb.textContent='';
      q.options.forEach((opt, idx)=>{
        const card=document.createElement('button'); card.className='option'; card.type='button'; card.setAttribute('aria-pressed','false');
        card.innerHTML = opt.textOnly
          ? `<div style="display:flex;align-items:center;justify-content:center;min-height:220px;font-size:64px">🅰️</div>
             <footer><span class="name">${opt.name}</span><span class="sound-btn" role="button" tabindex="0" aria-label="ฟังคำว่า ${opt.name}">🔊 ฟังเสียง</span></footer>
             <div class="mark">✔</div>`
          : `<img class="opt-img" data-key="${opt.key}" src="${opt.img}" alt="${opt.alt}">
             <footer><span class="name">${opt.name}</span><span class="sound-btn" role="button" tabindex="0" aria-label="ฟังเสียงของ ${opt.name}">🔊 ฟังเสียง</span></footer>
             <div class="mark">✔</div>`;
        card.addEventListener('click',(e)=>{
          if(e.target && e.target.classList.contains('sound-btn')) return;
          [...options.children].forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected'); st.selected=idx; submit.disabled=false; fb.textContent='';
        });
        const soundEl = card.querySelector('.sound-btn');
        if(soundEl){
          const playSound = ()=>{ opt.textOnly ? speakThai(opt.name) : playAnimalSound(opt.key); };
          soundEl.addEventListener('click',(e)=>{ e.stopPropagation(); playSound(); });
          soundEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); e.stopPropagation(); playSound(); } });
        }
        if(!opt.textOnly){
          const img = card.querySelector('.opt-img');
          img.addEventListener('click',(e)=>{
            e.stopPropagation();
            [...options.children].forEach(c=>c.classList.remove('selected'));
            card.classList.add('selected'); st.selected=idx; submit.disabled=false; fb.textContent='';
            playAnimalSound(opt.key);
          });
        }else{
          card.addEventListener('dblclick', ()=> speakThai(opt.name));
        }
        options.appendChild(card);
      });
      submit.onclick=()=>{
        if(st.selected==null) return;
        const correct = st.selected===q.correctIndex;
        if(correct) st.score++;

        [...options.children].forEach((c,i)=>{
          const mark=c.querySelector('.mark');
          if(i===q.correctIndex){ c.classList.add('correct'); mark.title='ถูกต้อง'; }
          else if(i===st.selected){ c.classList.add('wrong'); mark.textContent='✖'; mark.title='ผิด'; }
        });
        fb.textContent = correct ? '✅ เก่งมาก! คำตอบถูกต้อง 🥳' : `❌ ยังไม่ถูกนะ คำตอบคือ “${q.correctName}” 💡`;
        submit.disabled=true; skip.classList.remove('hidden');

        clearTimeout(st.timer);
        st.timer = setTimeout(()=>nextQuiz(st), 5000);
      };
      skip.onclick=()=>{ clearTimeout(st.timer); nextQuiz(st); };
      document.getElementById('playAgain-quiz').onclick=()=> startQuizGame();
      qSpeakBtnQuiz.onclick = ()=> speakThai(currentQuestionTextQuiz);
    }
    function nextQuiz(st){
      st.idx++;
      if(st.idx < 10){ renderQuiz(st); } else { finishQuiz(st); }
    }
    function finishQuiz(st){
      document.getElementById('qBar-quiz').style.width='100%';
      const name=(localStorage.getItem('childName')||'น้องเก่ง');
      document.getElementById('certName-quiz').textContent=name;
      document.getElementById('certScore-quiz').textContent=`คะแนน: ${st.score}/10`;
      document.getElementById('certDate-quiz').textContent=new Date().toLocaleString('th-TH',{dateStyle:'long', timeStyle:'short'});
      setCertSummary('quiz');
      document.getElementById('finishBlock-quiz').classList.remove('hidden');
      document.getElementById('dlPdf-quiz').focus();
      logResult('quiz','เลือกคำตอบที่ถูกต้อง',st.score||0);
    }
    document.getElementById('dlJpg-quiz').addEventListener('click', async ()=>{
      const { dataUrl } = await captureCertificate('certificate-quiz');
      const a = document.createElement('a'); const name = (localStorage.getItem('childName')||'เด็กดี');
      a.href = dataUrl; a.download = `ผลงาน_${name}.jpg`; document.body.appendChild(a); a.click(); a.remove();
    });
    document.getElementById('dlPdf-quiz').addEventListener('click', async ()=>{
      const { jsPDF } = window.jspdf;
      const { canvas } = await captureCertificate('certificate-quiz');
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pdf = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
      const pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pageW/canvas.width, pageH/canvas.height);
      const w = canvas.width*ratio, h = canvas.height*ratio, x=(pageW-w)/2, y=(pageH-h)/2;
      pdf.addImage(imgData, 'JPEG', x, y, w, h);
      const name = (localStorage.getItem('childName')||'เด็กดี'); pdf.save(`ผลงาน_${name}.pdf`);
    });

    const LIFE_BANK = [
      {ask:'อะไรเอ่ยไว้สำหรับขีดเขียน?', correct:'สมุด', wrong:'โทรศัพท์'},
      {ask:'อะไรเอ่ยไว้สำหรับอ่านหาความรู้', correct:'หนังสือ', wrong:'ดินสอ'},
      {ask:'อะไรเอ่ยเอาไว้เขียน?', correct:'ดินสอ', wrong:'โทรศัพท์'},
      {ask:'อะไรเอ่ยเอาไว้ล้างมือให้สะอาด?', correct:'สบู่', wrong:'สมุด'},
      {ask:'อะไรเอ่ยเอาไว้สระผม?', correct:'แชมพู', wrong:'ไม้บรรทัด'},
      {ask:'อะไรเอ่ยเอาไว้แปรงฟัน?', correct:'แปรงฟัน', wrong:'ช้อน'},
      {ask:'อะไรเอ่ยเป่าลมให้เย็น?', correct:'พัดลม', wrong:'ครู'},
      {ask:'อะไรเอ่ยใส่เท้าเวลาเดิน กันไม่ให้เท้าเจ็บ?', correct:'รองเท้า', wrong:'เค้ก'},
      {ask:'อะไรเอ่ยใส่หนังสือและสมุดไปโรงเรียน?', correct:'กระเป๋า', wrong:'ตู้เย็น'},
      {ask:'อะไรเอ่ยเอาไว้เก็บของให้เย็น?', correct:'ตู้เย็น', wrong:'หนังสือ'},
      {ask:'อะไรเอ่ยใช้คุยกับเพื่อน ใช้ดูการ์ตูน และหาความรู้?', correct:'โทรศัพท์', wrong:'ครู'},
      {ask:'อะไรเอ่ยเอาไว้หนุนหัวตอนเรานอน?', correct:'หมอน', wrong:'ดินสอ'},
      {ask:'อะไรเอ่ยเอาไว้ใส่อาหาร?', correct:'จาน', wrong:'ช้อน'},
      {ask:'อะไรเอ่ยเอาไว้ตักข้าวกิน?', correct:'ช้อน', wrong:'ดินสอ'},
      {ask:'อะไรเอ่ยเอาไว้วัดระยะห่าง และทำให้ขีดดินสอเส้นตรงได้?', correct:'ไม้บรรทัด', wrong:'โทรศัพท์'},
      {ask:'อะไรเอ่ยเอาไว้ใช้กันฝนตอนฝนตก?', correct:'ร่ม', wrong:'เครื่องบิน'},
      {ask:'อะไรเอ่ยใช้ส่องไฟในที่มืด?', correct:'ไฟฉาย', wrong:'กระเป๋า'},
      {ask:'ใครเอ่ยคอยจับโจร?', correct:'ตำรวจ', wrong:'ครู'},
      {ask:'ใครเอ่ยปกป้องประเทศ?', correct:'ทหาร', wrong:'ชาวนา'},
      {ask:'ใครเอ่ยคอยรักษาคนป่วย?', correct:'หมอ', wrong:'ทหาร'},
      {ask:'ใครเอ่ยคอยดับไฟเวลาไฟไหม้?', correct:'นักดับเพลิง', wrong:'ช่างก่อสร้าง'},
      {ask:'ใครเอ่ยสั่งสอนนักเรียน?', correct:'ครู', wrong:'ตำรวจ'},
      {ask:'ใครเอ่ยปลูกข้าวและนำข้าวมาให้เรากิน?', correct:'ชาวนา', wrong:'ครู'},
      {ask:'ใครเอ่ยคอยสร้างบ้านและตึกให้พวกเรา?', correct:'ช่างก่อสร้าง', wrong:'ตำรวจ'},
      {ask:'อะไรเอ่ยเป็นของหวาน สำหรับงานวันเกิด?', correct:'เค้ก', wrong:'ข้าว'},
      {ask:'อะไรเอ่ยเป็นของหวาน?', correct:'อมยิ้ม', wrong:'ผัก'},
      {ask:'อะไรเอ่ยไว้กินเป็นอาหารหลัก?', correct:'ข้าว', wrong:'ไก่ทอด'},
      {ask:'อะไรเอ่ยเย็น ๆ หวาน ๆ กินแล้วสดชื่น?', correct:'ไอติม', wrong:'ข้าว'},
      {ask:'อะไรเอ่ยเป็นขนมกรุบกรอบ?', correct:'ขนม', wrong:'ไอติม'},
      {ask:'อะไรเอ่ยเป็นเครื่องดื่มจากวัว?', correct:'นม', wrong:'แครอท'},
      {ask:'อะไรเอ่ยเป็นผักสีส้ม กรอบๆ ไว้ประกอบอาหาร', correct:'แครอท', wrong:'เค้ก'},
      {ask:'อะไรเอ่ยใบเขียว ๆ กินแล้วแข็งแรง?', correct:'ผัก', wrong:'อมยิ้ม'},
      {ask:'อะไรเอ่ยทอดกรอบ ๆ กินกับซอสอร่อย?', correct:'ไก่ทอด', wrong:'เค้ก'},
      {ask:'อะไรเอ่ยทำจากแป้ง?', correct:'ขนมปัง', wrong:'ไอติม'},
      {ask:'อะไรเอ่ยมีสองล้อ วิ่งเร็วบนถนน?', correct:'รถจักรยานยนต์', wrong:'รถยนต์'},
      {ask:'อะไรเอ่ยมีสี่ล้อ พาเราไปเที่ยวได้?', correct:'รถยนต์', wrong:'รถจักรยานยนต์'},
      {ask:'อะไรเอ่ยมีที่นั่งหลายแถว เหมือนรถเล็กแต่ใหญ่กว่า?', correct:'รถตู้', wrong:'รถจักรยานยนต์'},
      {ask:'อะไรเอ่ยมีหลายที่นั่ง วิ่งรับคนเยอะๆ ?', correct:'รถบัส', wrong:'รถยนต์'},
      {ask:'อะไรมีไว้สำหรับขับขี่ในชุมชนเหมาะสำหรับเด็กและมีสองล้อ?', correct:'จักรยาน', wrong:'รถยนต์'},
      {ask:'อะไรเอ่ยแล่นอยู่บนทะเล สามารถขนของไปต่างประเทศได้?', correct:'เรือ', wrong:'เครื่องบิน'},
      {ask:'อะไรเอ่ยบินบนท้องฟ้า พาเราไปต่างประเทศ?', correct:'เครื่องบิน', wrong:'เรือ'},
      {ask:'อะไรเอ่ยบินได้ มีใบพัดหมุนอยู่ข้างบน?', correct:'เฮลิคอปเตอร์', wrong:'เครื่องบิน'},
      {ask:'อะไรเอ่ยวิ่งอยู่บนถนน คอยรับส่งนักเรียน', correct:'รถบัส', wrong:'จักรยาน'}
    ];
    const LIFE_ASSETS = {
      'สมุด': 'https://img.freepik.com/premium-vector/hand-drawn-book-cartoon-illustration-isolated-white-background_921039-24019.jpg',
      'หนังสือ': 'https://img.pikbest.com/png-images/qianku/cartoon-white-book-information-free-button_2049323.png!sw800',
      'ดินสอ': 'https://img.pikbest.com/png-images/qianku/cartoon-stationery-pencilpng_2144837.png!sw800',
      'สบู่': 'https://img.freepik.com/premium-vector/cartoon-soap-character-fighting-with-virus-isolated-white-background-vector-illustration_230920-1968.jpg',
      'แชมพู': 'https://img.pikbest.com/png-images/qiantu/hand-drawn-cartoon-shampoo-png-element_2734239.png!sw800',
      'แปรงฟัน': 'https://img.freepik.com/free-vector/happy-cleaning-big-tooth-with-toothbrush-white-background_1308-104155.jpg',
      'พัดลม': 'https://png.pngtree.com/png-clipart/20190116/ourlarge/pngtree-blue-fan-beautiful-fan-hand-painted-fan-cartoon-fan-png-image_404767.jpg',
      'รองเท้า': 'https://img.freepik.com/premium-vector/hand-drawn-summer-shoes-cartoon-vector-illustration-clipart-white-background_191095-38923.jpg',
      'กระเป๋า': 'https://img.freepik.com/premium-vector/red-school-bag-white-background-cartoon-vector-illustration_1324825-14520.jpg',
      'ตู้เย็น': 'https://img.freepik.com/premium-photo/cartoon-style-refrigerated-white-backgroun_862994-418221.jpg',
      'โทรศัพท์': 'https://www.j9phone.com/images/content/original-1694597486578.png',
      'หมอน': 'https://png.pngtree.com/png-vector/20191213/ourmid/pngtree-cute-pillow-illustration-vector-on-white-background-png-image_2073938.jpg',
      'จาน': 'https://img.freepik.com/premium-photo/blue-plate-isolated-white-background-cartoon-illustration_899449-75236.jpg',
      'ช้อน': 'https://img.freepik.com/premium-photo/slotted-spoon-2d-cartoon-illustraton-white-background-h_889056-37283.jpg',
      'ไม้บรรทัด': 'https://img.freepik.com/premium-vector/cartoon-ruler-set-against-white-backdrop_579306-7004.jpg',
      'ร่ม': 'https://img.freepik.com/premium-vector/umbrella-cartoon-vector-illustration-white-background_1293239-12526.jpg',
      'ไฟฉาย': 'https://i.pinimg.com/474x/d8/cd/f4/d8cdf44e6416d35128ef1d2ff39723b7.jpg',
      'กรรไกร': 'https://i.pinimg.com/736x/8b/55/1c/8b551c86ac4604035fb40c761872b820.jpg',
      'แก้วน้ำ': 'https://media.istockphoto.com/id/524535335/th/%E0%B8%A7%E0%B8%B4%E0%B8%84%E0%B9%80%E0%B8%95%E0%B8%AD%E0%B8%A3%E0%B9%8C/%E0%B9%81%E0%B8%81%E0%B9%89%E0%B8%A7%E0%B8%99%E0%B9%89%E0%B9%8D%E0%B8%B2%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%81%E0%B8%B2%E0%B8%A3%E0%B9%8C%E0%B8%95%E0%B8%B9%E0%B8%99.jpg?s=612x612&w=0&k=20&c=a3WdRqHeGLrN5iGGg43Sm25XmZThQktl13WEzH4jwj8=',
      'ตำรวจ': 'https://img.freepik.com/premium-photo/police-officer-2d-cartoon-illustraton-white-background_889056-38212.jpg',
      'ทหาร': 'https://img.freepik.com/premium-photo/army-action-cartoon-soldier-white-background_41969-39116.jpg',
      'หมอ': 'https://img.freepik.com/premium-vector/cute-girl-doctor-cartoon-white-background-cute-female-doctor-character-illustration_1249867-5074.jpg',
      'นักดับเพลิง': 'https://img.freepik.com/premium-photo/happy-fireman-cartoon-white-background_1106493-72101.jpg',
      'ครู': 'https://img.freepik.com/premium-photo/funny-3d-teacher-character-with-blackboard-white-background_407474-27666.jpg',
      'ชาวนา': 'https://img.freepik.com/premium-vector/farmer-cartoon-character-white-background_1639-29226.jpg',
      'ช่างก่อสร้าง': 'https://www.shutterstock.com/image-vector/classic-worker-carpenter-vector-civil-600nw-2485309197.jpg',
      'เค้ก': 'https://i.pinimg.com/1200x/03/c8/5a/03c85a7041cbb5a96b6d0c88cb41f347.jpg',
      'อมยิ้ม': 'https://img.freepik.com/premium-vector/cute-kawaiistyle-lollipop-candy-illustration-with-stars-happy-face-sweet-designs_1465813-1.jpg',
      'ข้าว': 'https://img.freepik.com/premium-vector/cute-rice-cartoon-rice-bowl-white-background-vector_1322206-12491.jpg',
      'ไอติม': 'https://img.freepik.com/premium-vector/ice-cream-cartoon-set_738849-1023.jpg',
      'ขนม': 'https://s.isanook.com/ca/0/ud/283/1416539/untitled-1.jpg?ip/resize/w728/q80/jpg',
      'นม': 'https://img.freepik.com/premium-vector/cute-colorful-milk-packaging-different-flavors_185694-651.jpg',
      'แครอท': 'https://img.freepik.com/premium-vector/cute-carrot-cartoon-character-illustration-white-background_1023984-4117.jpg',
      'ผัก': 'https://img.freepik.com/premium-psd/fresh-vegetables-cartoon-isolated-transparent-png-hd-free-stock-illustration-white-background_1178789-4000.jpg',
      'ไก่ทอด': 'https://img.pikbest.com/png-images/qiantu/hand-drawn-gourmet-delicious-fried-chicken-drumstick-cartoon-elements_2737998.png!sw800',
      'ขนมปัง': 'https://img.freepik.com/premium-vector/sandwich-cartoon-character-clipart-vector-illustration_1280610-1176.jpg',
      'เฟรนฟราย': 'https://st2.depositphotos.com/1354412/8885/v/450/depositphotos_88855744-stock-illustration-french-fries-cartoon-character.jpg',
      'รถจักรยานยนต์': 'https://img.freepik.com/premium-photo/sport-racing-motorbike-cartoon-icon-illustration_1240525-72697.jpg?w=360',
      'รถยนต์': 'https://img.freepik.com/premium-vector/cute-cartoon-car-illustration-isolated-white-background_1174662-3882.jpg',
      'จักรยาน': 'https://img.freepik.com/premium-vector/cute-bicycle-cartoon-white-background_1308-137385.jpg',
      'เรือ': 'https://img.freepik.com/premium-vector/sailboat-cartoon-sticker-clip-art-vector-design-with-white-background_579306-13693.jpg',
      'เครื่องบิน': 'https://i.pinimg.com/1200x/1e/7c/dd/1e7cdd9df0fef8fd78be0b33aa7d50fc.jpg',
      'เฮลิคอปเตอร์': 'https://img.freepik.com/premium-photo/cartoon-military-helicopter-white-background_308643-1212.jpg',
      'รถบัส': 'https://i.pinimg.com/736x/25/13/dc/2513dcce7c76fa38fb89b9403511b7d0.jpg',
      'รถตู้': 'https://img.freepik.com/premium-vector/isolated-cartoon-van-vehicle-illustration-transportation-themes_1263357-23999.jpg'
    };
    function lifeOptionToObj(name){
      if(nameToAnimal[name]){ const an = nameToAnimal[name]; return { name, key: an.key, img: an.imageUrl, alt: `รูป${name}` }; }
      if(LIFE_ASSETS[name]){ return { name, img: LIFE_ASSETS[name], alt:`รูป${name}` }; }
      return { name, textOnly:true };
    }
    const qSpeakBtnLife = document.getElementById('qSpeakBtn-life');
    let currentQuestionTextLife = "…";
    function startLifeGame(){
      showScreen('life');
      const shuffled=[...LIFE_BANK].sort(()=>Math.random()-0.5).slice(0,10);
      const state = {
        idx:0, score:0, selected:null,
        quiz:shuffled.map(q=>{
          const correctIndex=Math.random()<0.5?0:1;
          const leftName  = correctIndex ? q.wrong : q.correct;
          const rightName = correctIndex ? q.correct : q.wrong;
          return { ask:q.ask, correctIndex, options:[ lifeOptionToObj(leftName), lifeOptionToObj(rightName) ], correctName:q.correct };
        }),
        timer:null
      };
      renderLife(state);
    }
    function renderLife(st){
      const q = st.quiz[st.idx];
      const qTextEl = document.getElementById('qText-life');
      const qIndex = document.getElementById('qIndex-life');
      const qBar = document.getElementById('qBar-life');
      const options = document.getElementById('options-life');
      const submit = document.getElementById('submitBtn-life');
      const skip = document.getElementById('skipWaitBtn-life');
      const fb = document.getElementById('feedback-life');
      currentQuestionTextLife = q.ask;
      qTextEl.textContent = addEmojis(q.ask,2);
      qIndex.textContent = st.idx+1;
      qBar.style.width = `${(st.idx)/10*100}%`;
      options.innerHTML=''; st.selected=null; submit.disabled=true; skip.classList.add('hidden'); fb.textContent='';
      q.options.forEach((opt, idx)=>{
        const card=document.createElement('button'); card.className='option'; card.type='button';
        card.innerHTML = opt.textOnly
          ? `<div style="display:flex;align-items:center;justify-content:center;min-height:220px;font-size:64px">🅰️</div>
             <footer><span class="name">${opt.name}</span></footer>
             <div class="mark">✔</div>`
          : `<img class="opt-img" ${opt.key?`data-key="${opt.key}"`:''} src="${opt.img}" alt="${opt.alt}">
             <footer><span class="name">${opt.name}</span>${opt.key ? `<button class="sound-btn" type="button" aria-label="ฟังเสียงของ ${opt.name}">🔊 ฟังเสียง</button>` : ''}</footer>
             <div class="mark">✔</div>`;
        card.addEventListener('click', (e)=>{
          if(e.target && e.target.classList.contains('sound-btn')) return;
          [...options.children].forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected'); st.selected=idx; submit.disabled=false; fb.textContent='';
          if(opt.key) playAnimalSound(opt.key);
                    if(opt.key) playAnimalSound(opt.key); else speakThai(opt.name);
        });
        const imgEl = card.querySelector('.opt-img');
        if(imgEl){
          imgEl.addEventListener('click',(e)=>{
            e.stopPropagation();
            [...options.children].forEach(c=>c.classList.remove('selected'));
            card.classList.add('selected'); st.selected=idx; submit.disabled=false; fb.textContent='';
            if(opt.key) playAnimalSound(opt.key); else speakThai(opt.name);
          });
        }
        const sbtn = card.querySelector('.sound-btn');
        if(sbtn){
          sbtn.addEventListener('click',(e)=>{ e.stopPropagation(); playAnimalSound(opt.key); });
        }
        options.appendChild(card);
      });
      submit.onclick=()=>{
        if(st.selected==null) return;
        const correct = st.selected===q.correctIndex;
        if(correct) st.score++;
        [...options.children].forEach((c,i)=>{
          const mark=c.querySelector('.mark');
          if(i===q.correctIndex){ c.classList.add('correct'); mark.title='ถูกต้อง'; }
          else if(i===st.selected){ c.classList.add('wrong'); mark.textContent='✖'; mark.title='ผิด'; }
        });
        fb.textContent = correct ? '✅ เก่งมาก! คำตอบถูกต้อง 🥳' : `❌ ยังไม่ถูกนะ คำตอบคือ “${q.correctName}” 💡`;
        submit.disabled=true; skip.classList.remove('hidden');
        clearTimeout(st.timer);
        st.timer=setTimeout(()=>nextLife(st),5000);
      };
      skip.onclick=()=>{ clearTimeout(st.timer); nextLife(st); };
      document.getElementById('playAgain-life').onclick=()=> startLifeGame();
      qSpeakBtnLife.onclick = ()=> speakThai(currentQuestionTextLife);
    }
    function nextLife(st){
      st.idx++;
      if(st.idx<10) renderLife(st);
      else finishLife(st);
    }
    function finishLife(st){
      document.getElementById('qBar-life').style.width='100%';
      const name=(localStorage.getItem('childName')||'น้องเก่ง');
      document.getElementById('certName-life').textContent=name;
      document.getElementById('certScore-life').textContent=`คะแนน: ${st.score}/10`;
      document.getElementById('certDate-life').textContent=new Date().toLocaleString('th-TH',{dateStyle:'long', timeStyle:'short'});
      setCertSummary('life');
      document.getElementById('finishBlock-life').classList.remove('hidden');
      document.getElementById('dlPdf-life').focus();
      logResult('life','ชีวิตประจำวัน',st.score||0);
    }
    document.getElementById('dlJpg-life').addEventListener('click', async ()=>{
      const { dataUrl } = await captureCertificate('certificate-life');
      const a = document.createElement('a');
      const name = (localStorage.getItem('childName')||'เด็กดี');
      a.href = dataUrl;
      a.download = `ผลงาน_${name}.jpg`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
    document.getElementById('dlPdf-life').addEventListener('click', async ()=>{
      const { jsPDF } = window.jspdf;
      const { canvas } = await captureCertificate('certificate-life');
      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const pdf = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
      const pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pageW/canvas.width, pageH/canvas.height);
      const w = canvas.width*ratio, h = canvas.height*ratio, x=(pageW-w)/2, y=(pageH-h)/2;
      pdf.addImage(imgData, 'JPEG', x, y, w, h);
      const name = (localStorage.getItem('childName')||'เด็กดี');
      pdf.save(`ผลงาน_${name}.pdf`);
    });

    const nameInput = document.getElementById('childName');
    const saveNameBtn = document.getElementById('saveNameBtn');
    (function preloadName(){
      const saved = localStorage.getItem('childName') || '';
      if(saved){ nameInput.value = saved; }
    })();
    saveNameBtn.addEventListener('click', ()=>{
      const v = (nameInput.value || '').trim();
      if(!v){ alert('พิมพ์ชื่อก่อนนะครับ 😊'); return; }
      localStorage.setItem('childName', v);
      speakThai(`บันทึกชื่อ ${v} แล้วครับ`);
      saveNameBtn.textContent = 'บันทึกแล้ว ✅';
      setTimeout(()=> saveNameBtn.textContent='บันทึก', 1200);
    });
    nameInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ saveNameBtn.click(); }
    });

    document.addEventListener('DOMContentLoaded', ()=> { showScreen('home'); });
    async function fetchStats(){
    try{
      const res = await fetch(APPS_SCRIPT_URL + '?action=stats', { cache:'no-store' });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'fetch stats failed');
      // data = { ok, perGameCounts, perGameScores, sheetUrl, sheetId }
    return {
      rows: null,                // ไม่จำเป็นแล้ว
      headers: [],
      perGameCounts: data.perGameCounts || {},
      perGameScores: data.perGameScores || {},
      sheetUrl: data.sheetUrl || null
    };
    }catch(err){
      console.warn('fetchStats() failed:', err);
      return { rows:null, headers:[], perGameCounts:{}, perGameScores:{} };
    }
    }
    function aggregateRows(rows){
      const perGameCounts = {};
      const perGameScores = {};
      for(const g of games.map(g=>g.id)){ perGameCounts[g]=0; perGameScores[g]=Array(10).fill(0); }
      rows.forEach(r=>{
        const g = r.gameId;
        if(!perGameCounts[g]){ perGameCounts[g]=0; perGameScores[g]=Array(10).fill(0); }
        perGameCounts[g] += 1;
        const sc = Math.max(1, Math.min(10, Number(r.score)||0));
        perGameScores[g][sc-1] += 1;
      });
      return { perGameCounts, perGameScores };
    }
    let pieChart;
    function renderPie(perGameCounts){
      const labels = Object.keys(perGameCounts)
        .filter(k=>perGameCounts[k]>0)
        .map(k=> GAME_TITLES[k] || k);
      const data   = Object.keys(perGameCounts).filter(k=>perGameCounts[k]>0).map(k=>perGameCounts[k]);
      const total  = data.reduce((a,b)=>a+b,0);
      const caption = document.getElementById('pieCaption');
      caption.textContent = `รวมผู้เล่นทั้งหมด ${total.toLocaleString('th-TH')} คน`;
      const ctx = document.getElementById('pieChart').getContext('2d');
      if(pieChart) pieChart.destroy();
      pieChart = new Chart(ctx, {
        type:'pie',
        data:{ labels, datasets:[{ data }]},
        options:{
          responsive:true,
          plugins:{
            legend:{ position:'bottom', labels:{ boxWidth:18 } },
            tooltip:{ callbacks:{
              label:(c)=>{
                const v = c.parsed; const p = total? Math.round(v*1000/total)/10 : 0;
                return `${c.label} — ${v.toLocaleString('th-TH')} คน (${p}%)`;
              }
            }}
          }
        }
      });

      const right = document.getElementById('pieRightText');
      const lines = [];
      lines.push(`เกมทั้งหมดมีผู้เล่นรวม <b>${total.toLocaleString('th-TH')}</b> คน`);
      Object.keys(perGameCounts).forEach(k=>{
        const name = GAME_TITLES[k] || k;
        const v = perGameCounts[k]||0;
        lines.push(`เกม <b>${name}</b> มีเด็กเข้าเล่นจำนวน <b> ${v.toLocaleString('th-TH')}</b> จากจำนวน ${total.toLocaleString('th-TH')} คน`);
      });
      right.innerHTML = lines.map(l=>`<div style="margin:6px 0">${l}</div>`).join('');
    }

    let barChart;
    function renderBarFor(gameId, perGameScores){
      const src = perGameScores[gameId] || {};
      const counts = Array.from({length:10}, (_,i)=>{
      const k = String(i+1);
      return Array.isArray(src) ? Number(src[i] || 0) : Number(src[k] || 0);
    });

    const labels = Array.from({length:10},(_,i)=> (i+1).toString());
    const ctx = document.getElementById('barChart').getContext('2d');
    if(barChart) barChart.destroy();
    barChart = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ data: counts }]},
      options:{
        responsive:true,
        scales:{
          x:{ title:{ display:true, text:'คะแนน' } },
          y:{ beginAtZero:true, title:{ display:true, text:'จำนวนคน' } }
        },
        plugins:{
          legend:{ display:false },
          tooltip:{ callbacks:{
          label:(c)=> `คะแนน ${c.label} — ${c.parsed.y.toLocaleString('th-TH')} คน`
          }}
        }
      }
    });

  const TOK = counts.reduce((a,b)=>a+b,0);
  let ETidx = 0, RTidx = 0, maxV = -1, minV = Number.POSITIVE_INFINITY;
  counts.forEach((v,i)=>{ if(v>maxV){maxV=v; ETidx=i;} if(v<minV){minV=v; RTidx=i;} });
  const ET = ETidx+1, RT = RTidx+1;

  const name = GAME_TITLES[gameId] || gameId;
  const right = document.getElementById('barRightText');
  const rows = [];
  rows.push(`<div style="font-size:22px; font-weight:800; margin:6px 0 10px">จำนวนคนเล่นเกม ${name} มีทั้งหมด <b>${TOK.toLocaleString('th-TH')}</b> คน</div>`);
  rows.push(`<div style="font-size:18px; margin:4px 0">ได้มากที่สุดคือ <b>${ET}</b></div>`);
  rows.push(`<div style="font-size:18px; margin:4px 0">ได้น้อยที่สุดคือ <b>${RT}</b></div>`);
  rows.push(`<div style="font-size:18px; margin:8px 0 6px">สรุปจำนวนคนได้คะแนน</div>`);
  for(let sc=10; sc>=1; sc--){
    const v = counts[sc-1]||0;
    rows.push(`<div style="margin:2px 0"> <b>${sc}</b> คะแนน จำนวน <b>${v.toLocaleString('th-TH')}</b> คน</div>`);
  }
  right.innerHTML = rows.join('');
}

    function buildTabs(perGameScores){
      const box = document.getElementById('gameTabs');
      box.innerHTML='';

      const order = games.map(g=>g.id).filter(id=>{
        const src = perGameScores[id];
        if(!src) return false;
        if(Array.isArray(src)) return src.some(n=>Number(n||0)>0);
        return Object.values(src).some(n=>Number(n||0)>0);
      });

      order.forEach((id,idx)=>{
        const b = document.createElement('button');
        b.className = 'tab' + (idx===0?' active':'');
        b.textContent = GAME_TITLES[id] || id;
        b.dataset.game = id;
        b.addEventListener('click',()=>{
          [...box.children].forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          renderBarFor(id, perGameScores);
        });
        box.appendChild(b);
      });

      if(order.length) renderBarFor(order[0], perGameScores);
      else {
        const ctx = document.getElementById('barChart').getContext('2d');
        if(barChart) { barChart.destroy(); barChart = null; }
        document.getElementById('barRightText').innerHTML = '<div class="muted">ยังไม่มีข้อมูลคะแนนสำหรับกราฟแท่ง</div>';
      }
    }

    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.isIntersecting) e.target.classList.add('show');
        else e.target.classList.remove('show');
      });
    }, { threshold: 0.15 });

    document.querySelectorAll('.reveal').forEach(el=> io.observe(el));

    (async ()=>{
      const raw = await fetchStats();
      let perGameCounts = raw.perGameCounts;
      let perGameScores = raw.perGameScores;

      if(raw.rows){ const agg = aggregateRows(raw.rows); perGameCounts = agg.perGameCounts; perGameScores = agg.perGameScores; }

      renderPie(perGameCounts);
      buildTabs(perGameScores);
    })();
  </script>
</body>
</html>
